<# 
.SYNOPSIS
    This script takes the domains.txt file that you will download from www.maledomains.com and creates a perfectly formatted .xml file to be imported into McAfee HIPS 
    Firewall. 

.USAGE
    1) Download and uncompress the domains file located at http://malware-domains.com/files/domains.zip
    2) Run this script from the same directory in which the domains.text file is located
    3) Once complete, a file called Domains_DNS_Policy.xml will be created
    4) Import the policy into McAfee Hips Firewall

   WARNING
        When I uploaded over 14000 entries to HIPS, the system began moving really slow. I recommend that you slim down the amount of records you upload. I could not 
        find any documentation from McAfee concerning the matter.
#>


# Returns only the website name
$sites_spaces = Get-Content .\domains.txt | select -skip 4 | Foreach {($_ -split '\s+',4)[0..1]}

# Removes empty (blank) lines
$just_sites = $sites_spaces | where {$_ -ne ""}

# Count the number of lines in the file
$total_lines = $just_sites.count

# Makes a list of the numbers
$lines = 0..$total_lines | select -skiplast 1

# Loops through the numbers and the site names and combines them in the desired format
for($i=0; $i -lt $just_sites.length; $i++)
{
    '<Setting name="+BlockedDomains#' + $lines[$i] + '" value="*' + $just_sites[$i] + '"/>' >> block.txt
}

# Adds the other parts of the file
$top_part = '<?xml version="1.0" encoding="UTF-8"?>
<epo:EPOPolicySchema xmlns:epo="mcafee-epo-policy" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<EPOPolicyVerInfo vermjr="5" vermin="1" verrel="0" verbld="0"/>
<EPOPolicySettings name="Media2::Settings (E539ADEB-BAA4-46D3-833E-5A6C400D9DAE)" featureid="HOSTIPS_8000_FW" categoryid="FW_BlockedDomains" typeid="FW_BlockedDomains" param_int="200" param_str="BlockedDomains">
<Section name="BlockedDomains">'

$bottom_part = '<Setting name="LastModified" value="2016-12-19T13:48:28.792-05:00"/>
<Setting name="LastModifyingUsername" value="admin"/>
<Setting name="_BlockedDomains" value="'+ $total_lines + '"/>
</Section>
</EPOPolicySettings>
<EPOPolicyObject name="MalwareDomains.com_DNS_Policy" featureid="HOSTIPS_8000_FW" categoryid="FW_BlockedDomains" serverid="MLD-EPO" editflag="0" typeid="FW_BlockedDomains">
<description></description><PolicySettings>Media2::Settings (E539ADEB-BAA4-46D3-833E-5A6C400D9DAE)</PolicySettings>
</EPOPolicyObject>
</epo:EPOPolicySchema>'

# Combines all parts of the file together
Add-Content -Path "Domains_DNS_Policy.txt" -Value ($top_part)
Add-Content -Path "Domains_DNS_Policy.txt" -Value (Get-Content ".\block.txt")
Add-Content -Path "Domains_DNS_Policy.txt" -Value ($bottom_part)

# Renames the .txt file to .xml... the format needed to import the file into McAfee HIPs
Rename-Item .\Domains_DNS_Policy.txt .\Domains_DNS_Policy.xml