0 - Web
0. change passwd
passwd root # temp password

POSSIBLE UNLESS SCORING STOPS.  kills every established connection every n seconds
watch -n 12 "netstat -tunap | grep EST | awk '{print \$7}' | cut -d '/' -f 1 | xargs kill -kill"


1. Turn off SSH
service sshd stop
chkconfig sshd off

2. Backup
tar pcf /usr/bu.tar /etc /var/www /home /root &  
# covers passwd, shadow, password protect

vim commands
:w
save file
:!chmod +x %
make file executable
:!./%
run file


2. rules.sh
#!/bin/sh

iptables -F

iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT

# IPV4 INPUT

iptables -A INPUT -p udp --sport 53 -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp -m multiport --dports 20,21,80,443,10000:10005 -j ACCEPT

iptables -A INPUT -j DROP # TARPIT

RUN THE SCRIPT 
:wq
chmod +x rules.sh`
./rules.sh
netstat -tunap | grep EST | awk ‘{print $7}’ | cut -d “/” -f 1
netstat -tunap | grep EST | awk ‘{print $7}’ | cut -d “/” -f 1 | xargs kill -kill



# IPV4 OUTPUT INITIAL

iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -p tcp -m multiport --dports 80,443,389,3306 -j ACCEPT # wget/curl/browser, sql inbound for remote
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -j DROP # TARPIT

iptables -L -n

RUN THE SCRIPT


PLACE IN APPROPRIATE PLACES WHEN READY (8 is request, 0 is reply)
# iptables -A OUTPUT -p icmp --icmp-type 0 -j ACCEPT
# iptables -A OUTPUT -p icmp --icmp-type 8 -j ACCEPT

# iptables -A INPUT -p icmp --icmp-type 0 -j ACCEPT
# iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT

# iptables -A OUTPUT -p udp --dport 53 -d <ip in resolv.conf> -j ACCEPT # DNS
# iptables -A INPUT -p udp --sport 53 -s <ip in resolv.conf> -j ACCEPT # DNS

remove previous dns entries

# IPV6 INPUT/OUTPUT - might be disabled
CHECK IF ON BOX
:!ip6tables -L

ip6tables -F
ip6tables -A INPUT -j DROP # TARPIT
ip6tables -A OUTPUT -j DROP # TARPIT

# SYN Cookies
echo 1 > /proc/sys/net/ipv4/tcp_syncookies


3. Quick Proftp secure

vim /etc/proftp.conf
ServerName			FTP Server
ServerIdent			off

DefaultRoot			~
check DefaultChdir
check User and Group			
PassivePorts 10000	10005
comment anonymous section out
restart proftpd


3a.  VSFTP quick secure
anonymous_enable no 
if needed, then check for anon_root
check ftp_username
ftpd_banner “Filezilla FTP”
pasv_enable yes
pasv_min_port 10000
pasv_max_port 10005
restart vsftpd

3. Update WATCH SPACE ON DISK  df -h du -sh /*
yum makecache
yum update php apache httpd # get the most useful first..
yum update -y # red hat
aptitude -y update && aptitude -y upgrade # debian
zypper update # opensuse
emerge --sync && emerge --update apache php# gentoo

4. /etc/bashrc - REWRITE, profile??
touch /var/log/cmds.log
chmod 777 /var/log/cmds.log
PLACE IN /etc/bashrc
export PROMPT_COMMAND='echo "$(date +%x-%X) [$$] $USER $(history 1) $SSH_TTY" >> /var/log/cmds.log'


5. turn off unnecessary processes and services
netstat -tunap > netstat.orig
ps -ef > ps.orig
service --status-all >& services.orig
	chkconfig --list

getent passwd > users.orig
getent group > group.orig

service atd stop (redhat)
chkconfig atd off
service crond stop 
chkconfig cron off
service anacron stop (redhat)
chkconfig anacron off


# NEED protection against reboot/login
chkconfig [service] off # CENTOS, systemctl is other option
update-rc.d bind9 remove # UBUNTU - usage is not encouraged in the docs
	sudo vim /etc/init/SERVICE.override"  and type “manual” Ubuntu recommended method
iptables -L # in case they are flushing it

6. Secure scored services
LOOK AT DOMAINS HOSTED ON BOX
migrate sql to web box  # best practices dictates NOPE
	phpMyAdmin, c99 shell (grep -R shell_exec /var/www egrep -ioR “r57|c99” /var/www), webmin (port 10000)


PHP → MYSQL → APACHE → Modsecurity
need automated scripts

7. Per convenience
crontab -l
